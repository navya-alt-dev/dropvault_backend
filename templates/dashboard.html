<!DOCTYPE html>
<html>
<head>
  <title>DropVault - Dashboard</title>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { 
      max-width: 900px; 
      margin: 0 auto; 
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 30px;
    }
    h1 { color: #333; margin-bottom: 5px; }
    h2 { color: #555; font-size: 1.2em; margin: 20px 0 15px; }
    .user-info { color: #666; margin-bottom: 25px; }
    
    .upload-box { 
      background: #f8f9fa; 
      border: 2px dashed #ddd; 
      border-radius: 12px; 
      padding: 25px;
      margin-bottom: 25px;
    }
    .upload-box:hover { border-color: #667eea; }
    .upload-form { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .upload-form input[type="file"] { flex: 1; min-width: 200px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
    
    .btn { 
      padding: 12px 20px; border: none; border-radius: 8px; 
      cursor: pointer; font-weight: 600; font-size: 14px;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
    .btn-danger { background: #dc3545; color: #fff; }
    .btn-success { background: #28a745; color: #fff; }
    .btn-secondary { background: #6c757d; color: #fff; }
    .btn-sm { padding: 8px 14px; font-size: 12px; }
    
    .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
    .tab { 
      padding: 12px 24px; background: none; border: none;
      border-bottom: 3px solid transparent; cursor: pointer;
      font-weight: 600; color: #888; margin-bottom: -2px;
    }
    .tab:hover { color: #667eea; }
    .tab.active { color: #667eea; border-bottom-color: #667eea; }
    
    .file-item { 
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px; border: 1px solid #eee; border-radius: 10px;
      margin-bottom: 10px; gap: 15px; flex-wrap: wrap;
    }
    .file-item:hover { border-color: #667eea; background: #fafafa; }
    .file-info { flex: 1; min-width: 200px; }
    .file-name { font-weight: 600; color: #333; }
    .file-meta { color: #888; font-size: 0.85em; margin-top: 4px; }
    .file-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    
    .share-wrap { position: relative; }
    .share-menu { 
      display: none; position: absolute; right: 0; top: 100%;
      background: #fff; border: 1px solid #ddd; border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 20px;
      z-index: 1000; min-width: 300px; margin-top: 8px;
    }
    .share-menu.open { display: block; }
    .share-menu h4 { margin: 0 0 15px; color: #333; }
    .share-menu input, .share-menu textarea { 
      width: 100%; padding: 10px; border: 1px solid #ddd; 
      border-radius: 6px; margin-bottom: 10px;
    }
    .share-menu textarea { height: 60px; resize: vertical; }
    .share-menu label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 0.9em; }
    .share-menu .btn { width: 100%; justify-content: center; margin-bottom: 10px; }
    .share-menu hr { border: none; border-top: 1px solid #eee; margin: 15px 0; }
    
    .status { padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.loading { background: #fff3cd; color: #856404; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    
    .link-box { margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 6px; display: none; }
    .link-box input { margin: 0; font-size: 12px; }
    
    .trash-notice { background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 15px; color: #856404; font-size: 0.9em; }
    .days-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.8em; font-weight: 600; margin-top: 5px; }
    .days-badge.safe { background: #d4edda; color: #155724; }
    .days-badge.warn { background: #fff3cd; color: #856404; }
    .days-badge.danger { background: #f8d7da; color: #721c24; }
    
    .empty { text-align: center; padding: 50px 20px; color: #888; }
    .empty .icon { font-size: 3.5em; margin-bottom: 15px; opacity: 0.5; }
    
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #ddd; border-top-color: #667eea; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; }
    .modal.show { display: flex; }
    .modal-box { background: #fff; padding: 30px; border-radius: 16px; max-width: 400px; text-align: center; }
    .modal-box h3 { margin-bottom: 15px; color: #333; }
    .modal-box p { margin-bottom: 20px; color: #666; }
    
    .shared-section { margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; }
    .shared-item { padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; }
  </style>
</head>
<body>

<!-- Session Expired Modal -->
<div id="sessionModal" class="modal">
  <div class="modal-box">
    <h3>âš ï¸ Session Expired</h3>
    <p>Please login again to continue.</p>
    <a href="/accounts/login/" class="btn btn-primary">ğŸ” Login</a>
  </div>
</div>

<div class="container">
  <h1>ğŸ“ DropVault</h1>
  <p class="user-info">Welcome, <strong>{{ user.email }}</strong></p>

  <!-- Upload -->
  <div class="upload-box">
    <form id="uploadForm" class="upload-form" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="file" name="file" id="fileInput" required>
      <button type="submit" class="btn btn-primary" id="uploadBtn">ğŸ“¤ Upload</button>
    </form>
    <div id="uploadStatus"></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="files">ğŸ“ My Files</button>
    <button class="tab" data-tab="trash">ğŸ—‘ï¸ Trash (<span id="trashCount">0</span>)</button>
  </div>

  <!-- Files -->
  <div id="filesSection">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
      <h2>Your Files</h2>
      <button onclick="loadFiles()" class="btn btn-secondary btn-sm">ğŸ”„ Refresh</button>
    </div>
    <div id="fileList"><div class="empty"><span class="spinner" style="width:40px;height:40px;border-width:3px;"></span></div></div>
  </div>

  <!-- Trash -->
  <div id="trashSection" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
      <h2>ğŸ—‘ï¸ Trash</h2>
      <button onclick="loadTrash()" class="btn btn-secondary btn-sm">ğŸ”„ Refresh</button>
    </div>
    <div class="trash-notice">âš ï¸ Files deleted permanently after 30 days</div>
    <div id="trashList"><div class="empty"><span class="spinner" style="width:40px;height:40px;border-width:3px;"></span></div></div>
  </div>

  <!-- Shared Links -->
  <div class="shared-section">
    <h2>ğŸ”— Shared Links</h2>
    {% if shared_links %}
      {% for link in shared_links %}
        <div class="shared-item">
          <strong>ğŸ“„ {{ link.file.original_name }}</strong>
          <div style="font-family:monospace;font-size:0.85em;background:#f5f5f5;padding:5px 8px;border-radius:4px;margin-top:5px;">/s/{{ link.slug }}/</div>
          <div style="font-size:0.85em;color:#666;margin-top:5px;">
            ğŸ‘ï¸ {{ link.view_count }} views â€¢ â¬‡ï¸ {{ link.download_count }}/{{ link.max_downloads }} â€¢
            {% if link.is_expired %}<span style="color:#dc3545;">âŒ Expired</span>{% else %}<span style="color:#28a745;">âœ… Active</span>{% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty" style="padding:20px;"><p>No shared links yet</p></div>
    {% endif %}
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSRF TOKEN - Get fresh token
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getCSRFToken() {
  // Try meta tag first
  const meta = document.querySelector('meta[name="csrf-token"]');
  if (meta) return meta.content;
  
  // Try cookie
  const cookies = document.cookie.split(';');
  for (let c of cookies) {
    const [name, value] = c.trim().split('=');
    if (name === 'csrftoken') return value;
  }
  
  // Fallback
  return '{{ csrf_token }}';
}

const csrfToken = getCSRFToken();
console.log('ğŸ” CSRF Token:', csrfToken ? 'Found' : 'Missing');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoginRequired() {
  document.getElementById('sessionModal').classList.add('show');
}

function handleAuthError(data) {
  if (data && (data.login_required || data.redirect)) {
    showLoginRequired();
    return true;
  }
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH WRAPPER - Handles all API calls
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(url, options = {}) {
  const defaultHeaders = {
    'X-CSRFToken': csrfToken,
    'Accept': 'application/json'
  };
  
  // Don't set Content-Type for FormData
  if (!(options.body instanceof FormData)) {
    defaultHeaders['Content-Type'] = 'application/json';
  }
  
  const config = {
    credentials: 'same-origin',
    ...options,
    headers: {
      ...defaultHeaders,
      ...options.headers
    }
  };
  
  console.log(`ğŸŒ API: ${options.method || 'GET'} ${url}`);
  
  try {
    const response = await fetch(url, config);
    const contentType = response.headers.get('content-type') || '';
    
    // Check if response is JSON
    if (!contentType.includes('application/json')) {
      console.error('âŒ Server returned HTML (not JSON)');
      // Likely auth error - show login
      if (response.status === 401 || response.status === 403 || response.status === 302) {
        showLoginRequired();
        throw new Error('Session expired. Please login again.');
      }
      throw new Error('Server error. Please try again.');
    }
    
    const data = await response.json();
    
    // Check for auth errors in response
    if (response.status === 401 || handleAuthError(data)) {
      throw new Error('Please login to continue.');
    }
    
    return { ok: response.ok, status: response.status, data };
    
  } catch (error) {
    console.error('âŒ API Error:', error);
    
    // Network error
    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
      throw new Error('Network error. Check your connection.');
    }
    
    throw error;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    const name = tab.dataset.tab;
    document.getElementById('filesSection').style.display = name === 'files' ? 'block' : 'none';
    document.getElementById('trashSection').style.display = name === 'trash' ? 'block' : 'none';
    
    if (name === 'files') loadFiles();
    else loadTrash();
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const fileInput = document.getElementById('fileInput');
  const btn = document.getElementById('uploadBtn');
  const status = document.getElementById('uploadStatus');
  
  if (!fileInput.files.length) {
    status.innerHTML = '<div class="status error">âŒ Select a file</div>';
    return;
  }
  
  const file = fileInput.files[0];
  console.log('ğŸ“¤ Uploading:', file.name, file.size);
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Uploading...';
  status.innerHTML = '<div class="status loading"><span class="spinner"></span> Uploading...</div>';
  
  const formData = new FormData();
  formData.append('file', file);
  
  try {
    const { ok, data } = await api('/files/upload/', {
      method: 'POST',
      body: formData,
      headers: {} // Let browser set content-type for FormData
    });
    
    if (ok) {
      status.innerHTML = '<div class="status success">âœ… Uploaded!</div>';
      fileInput.value = '';
      loadFiles();
      setTimeout(() => status.innerHTML = '', 3000);
    } else {
      throw new Error(data.error || data.message || 'Upload failed');
    }
  } catch (error) {
    console.error('Upload error:', error);
    status.innerHTML = `<div class="status error">âŒ ${esc(error.message)}</div>`;
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'ğŸ“¤ Upload';
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD FILES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFiles() {
  const list = document.getElementById('fileList');
  list.innerHTML = '<div class="empty"><span class="spinner" style="width:40px;height:40px;border-width:3px;"></span></div>';
  
  try {
    const { ok, data } = await api('/api/list/');
    
    if (!Array.isArray(data) || data.length === 0) {
      list.innerHTML = '<div class="empty"><div class="icon">ğŸ“</div><h3>No files</h3><p>Upload your first file!</p></div>';
      return;
    }
    
    list.innerHTML = data.map(f => `
      <div class="file-item" data-id="${f.id}">
        <div class="file-info">
          <div class="file-name">ğŸ“„ ${esc(f.filename)}</div>
          <div class="file-meta">${fmtSize(f.size)} â€¢ ${fmtDate(f.uploaded_at)}</div>
        </div>
        <div class="file-actions">
          <button onclick="deleteFile(${f.id})" class="btn btn-danger btn-sm">ğŸ—‘ï¸</button>
          <div class="share-wrap">
            <button onclick="toggleShare(${f.id})" class="btn btn-primary btn-sm">ğŸ“¤ Share</button>
            <div id="sm${f.id}" class="share-menu">
              <h4>ğŸ“¤ Share</h4>
              <button onclick="copyLink(${f.id})" class="btn btn-secondary">ğŸ”— Copy Link</button>
              <div id="lb${f.id}" class="link-box"><input id="li${f.id}" readonly onclick="this.select()"></div>
              <hr>
              <label>ğŸ“§ Email:</label>
              <input type="email" id="em${f.id}" placeholder="recipient@example.com">
              <label>Message:</label>
              <textarea id="mg${f.id}" placeholder="Check this out!"></textarea>
              <button onclick="sendEmail(${f.id})" class="btn btn-success">ğŸ“§ Send</button>
              <div id="ss${f.id}"></div>
            </div>
          </div>
        </div>
      </div>
    `).join('');
    
  } catch (error) {
    list.innerHTML = `<div class="empty"><div class="icon">âŒ</div><h3>Error</h3><p>${esc(error.message)}</p></div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE FILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function deleteFile(id) {
  if (!confirm('Move to trash?')) return;
  
  try {
    const { ok, data } = await api(`/files/delete/${id}/`, { method: 'POST' });
    if (ok) {
      document.querySelector(`[data-id="${id}"]`)?.remove();
      updateTrashCount();
    } else {
      throw new Error(data.error || 'Failed');
    }
  } catch (e) {
    alert('âŒ ' + e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD TRASH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTrash() {
  const list = document.getElementById('trashList');
  list.innerHTML = '<div class="empty"><span class="spinner" style="width:40px;height:40px;border-width:3px;"></span></div>';
  
  try {
    const { ok, data } = await api('/api/trash/');
    
    document.getElementById('trashCount').textContent = Array.isArray(data) ? data.length : 0;
    
    if (!Array.isArray(data) || data.length === 0) {
      list.innerHTML = '<div class="empty"><div class="icon">ğŸ—‘ï¸</div><h3>Empty</h3></div>';
      return;
    }
    
    list.innerHTML = data.map(f => {
      const d = f.days_remaining ?? 30;
      const c = d <= 7 ? 'danger' : d <= 14 ? 'warn' : 'safe';
      return `
        <div class="file-item" data-tid="${f.id}">
          <div class="file-info">
            <div class="file-name">ğŸ“„ ${esc(f.filename)}</div>
            <div class="file-meta">${fmtSize(f.size)}</div>
            <span class="days-badge ${c}">â° ${d} days</span>
          </div>
          <div class="file-actions">
            <button onclick="restoreFile(${f.id})" class="btn btn-success btn-sm">â™»ï¸ Restore</button>
          </div>
        </div>
      `;
    }).join('');
    
  } catch (e) {
    list.innerHTML = `<div class="empty"><div class="icon">âŒ</div><p>${esc(e.message)}</p></div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESTORE FILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function restoreFile(id) {
  if (!confirm('Restore?')) return;
  
  try {
    const { ok, data } = await api(`/api/restore/${id}/`, { method: 'POST' });
    if (ok) {
      document.querySelector(`[data-tid="${id}"]`)?.remove();
      updateTrashCount();
      alert('âœ… Restored!');
    } else {
      throw new Error(data.error || 'Failed');
    }
  } catch (e) {
    alert('âŒ ' + e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARE FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleShare(id) {
  document.querySelectorAll('.share-menu').forEach(m => {
    if (m.id !== `sm${id}`) m.classList.remove('open');
  });
  document.getElementById(`sm${id}`).classList.toggle('open');
}

document.addEventListener('click', e => {
  if (!e.target.closest('.share-wrap')) {
    document.querySelectorAll('.share-menu').forEach(m => m.classList.remove('open'));
  }
});

async function copyLink(id) {
  const ss = document.getElementById(`ss${id}`);
  const lb = document.getElementById(`lb${id}`);
  const li = document.getElementById(`li${id}`);
  
  ss.innerHTML = '<div class="status loading"><span class="spinner"></span> Creating...</div>';
  
  try {
    const { ok, data } = await api(`/files/share/${id}/`, {
      method: 'POST',
      body: '{}'
    });
    
    if (!ok) throw new Error(data.error || 'Failed');
    
    const url = data.share_url || data.link;
    li.value = url;
    lb.style.display = 'block';
    li.select();
    
    try {
      await navigator.clipboard.writeText(url);
      ss.innerHTML = '<div class="status success">âœ… Copied!</div>';
    } catch {
      ss.innerHTML = '<div class="status info">ğŸ“‹ Copy above</div>';
    }
    
    setTimeout(() => ss.innerHTML = '', 3000);
  } catch (e) {
    ss.innerHTML = `<div class="status error">âŒ ${esc(e.message)}</div>`;
  }
}

async function sendEmail(id) {
  const email = document.getElementById(`em${id}`).value.trim();
  const msg = document.getElementById(`mg${id}`).value.trim();
  const ss = document.getElementById(`ss${id}`);
  
  if (!email || !email.includes('@')) {
    ss.innerHTML = '<div class="status error">âŒ Enter valid email</div>';
    return;
  }
  
  ss.innerHTML = '<div class="status loading"><span class="spinner"></span> Sending...</div>';
  
  try {
    const { ok, data } = await api(`/files/share/${id}/email/`, {
      method: 'POST',
      body: JSON.stringify({ recipient_email: email, message: msg })
    });
    
    if (!ok) throw new Error(data.error || 'Failed');
    
    if (data.email_sent) {
      ss.innerHTML = `<div class="status success">âœ… Sent to ${esc(email)}!</div>`;
      document.getElementById(`em${id}`).value = '';
      document.getElementById(`mg${id}`).value = '';
    } else {
      ss.innerHTML = `<div class="status info">âš ï¸ Link created (email failed)<br><input value="${data.share_url}" onclick="this.select()" readonly style="width:100%;margin-top:5px;font-size:11px;"></div>`;
    }
  } catch (e) {
    ss.innerHTML = `<div class="status error">âŒ ${esc(e.message)}</div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updateTrashCount() {
  try {
    const { data } = await api('/api/trash/');
    document.getElementById('trashCount').textContent = Array.isArray(data) ? data.length : 0;
  } catch {}
}

function fmtSize(b) {
  if (!b) return '0 B';
  const k = 1024, s = ['B','KB','MB','GB'];
  const i = Math.floor(Math.log(b)/Math.log(k));
  return (b/Math.pow(k,i)).toFixed(1) + ' ' + s[i];
}

function fmtDate(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function esc(t) {
  if (!t) return '';
  const d = document.createElement('div');
  d.textContent = t;
  return d.innerHTML;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  console.log('ğŸš€ Dashboard ready');
  loadFiles();
  updateTrashCount();
});
</script>
</body>
</html>